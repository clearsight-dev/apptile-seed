require 'json'

def swap_package_json_for_appclip
  package_json_path = '../package.json'
  package_backup_path = '../package-backup.json'
  package_appclip_path = '../package-appclip.json'
  
  if File.exist?(package_json_path)
    puts 'Backing up package.json'
    File.rename(package_json_path, package_backup_path)
  else
    raise 'Error: package.json not found!'
  end
  
  if File.exist?(package_appclip_path)
    puts 'Enabling appclip package.json'
    File.rename(package_appclip_path, package_json_path)
  else
    raise 'Error: package-appclip.json not found!'
  end
    
  yield
  
  if File.exist?(package_json_path) && File.exist?(package_backup_path)
    puts 'Restoring original package.json'
    File.rename(package_json_path, package_appclip_path)
    File.rename(package_backup_path, package_json_path)
  else
    raise 'Error: Could not restore original state'
  end
end

# Resolve react_native_pods.rb with node to allow for hoisting
def node_require(script)
  # Resolve script with node to allow for hoisting
  require Pod::Executable.execute_command('node', ['-p',
    "require.resolve(
      '#{script}',
      {paths: [process.argv[1]]},
    )", __dir__]).strip
end
node_require('react-native/scripts/react_native_pods.rb')
node_require('react-native-permissions/scripts/setup.rb')
setup_permissions([
  'AppTrackingTransparency',
  # 'Bluetooth',
  # 'Calendars',
  # 'CalendarsWriteOnly',
  'Camera',
  # 'Contacts',
  # 'FaceID',
  # 'LocationAccuracy',
  # 'LocationAlways',
  'LocationWhenInUse',
  # 'MediaLibrary',
  'Microphone',
  # 'Motion',
  'Notifications',
  # 'PhotoLibrary',
  # 'PhotoLibraryAddOnly',
  # 'Reminders',
  # 'Siri',
  # 'SpeechRecognition',
  # 'StoreKit',
])

platform :ios, 15.6
prepare_react_native_project!

# use_modular_headers!

# If you are using a `react-native-flipper` your iOS build will fail when `NO_FLIPPER=1` is set.
# because `react-native-flipper` depends on (FlipperKit,...) that will be excluded
#
# To fix this you can also exclude `react-native-flipper` using a `react-native.config.js`
# ```js
# module.exports = {
#   dependencies: {
#     ...(process.env.NO_FLIPPER ? { 'react-native-flipper': { platforms: { ios: null } } } : {}),
# ```
# flipper_config = FlipperConfiguration.disabled 

linkage = ENV['USE_FRAMEWORKS']
if linkage != nil
  Pod::UI.puts "Configuring Pod with #{linkage}ally linked Frameworks".green
  use_frameworks! :linkage => linkage.to_sym
end

apptile_config_path = '../apptile.config.json'
apptile_config = JSON.parse(File.read(apptile_config_path))
feature_flags = apptile_config.fetch('feature_flags', {})
bundle_id = apptile_config.dig('ios', 'bundle_id') || 'com.apptile.apptilepreviewdemo'
FLAGS = feature_flags.select { |_key, value| [true,false].include?(value) }.keys

  print("running iosProjectSetup")
  setupResult = Pod::Executable.execute_command('node', ['../iosProjectSetup.js'])
  print(setupResult)
  print("iosProjectSetup complete\n")

target 'ImageNotification' do
  use_frameworks!
  pod 'GoogleUtilities'
  if feature_flags.fetch('ENABLE_MOENGAGE', false)
    puts "Installing MoEngageRichNotification flag in ImageNotification"
    pod 'MoEngageRichNotification'
  end
  if feature_flags.fetch('ENABLE_ONESIGNAL', false)
    puts "Installing onesignal core in ImageNotification"
    pod 'OneSignalXCFramework', '>= 5.0.0', '< 6.0'
  end
  if feature_flags.fetch('ENABLE_CLEVERTAP', false)
    puts "Installing clevertap in ImageNotification"
    pod 'CTNotificationService'
  end
  if feature_flags.fetch('ENABLE_KLAVIYO', false)
    puts "Installing klaviyo in ImageNotification"
    pod 'KlaviyoSwiftExtension'
  end
end

target 'NotificationContentExtension' do
  use_frameworks!
  if feature_flags.fetch('ENABLE_MOENGAGE', false)
    pod 'MoEngageRichNotification'
  end
  if feature_flags.fetch('ENABLE_CLEVERTAP', false)
    puts "Installing clevertap in ImageNotification"
    pod 'CTNotificationService'
  end
end

target 'apptileSeed' do
  use_frameworks!
  config = use_native_modules!
  
  if feature_flags.fetch('ENABLE_CLEVERTAP', false)
    puts "Setting clevertap path in apptileSeed"
    pod 'clevertap-react-native', :path => '../node_modules/clevertap-react-native'
  end

  if feature_flags.fetch('ENABLE_KLAVIYO', false)
    puts "Setting klaviyo path in apptileSeed"
    pod 'klaviyo-react-native-sdk', :path => '../node_modules/klaviyo-react-native-sdk'
  end

  use_react_native!(
    :path => config[:reactNativePath],
    # Enables Flipper.
    #
    # Note that if you have use_frameworks! enabled, Flipper will not work and
    # you should disable the next line.
    # :flipper_configuration => FlipperConfiguration.disabled,
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    :hermes_enabled => false
  )

  # target 'apptileSeedTests' do
  #   inherit! :complete
  #   # Pods for testing
  # end
  pod 'ZIPFoundation'
  pod 'Alamofire', '~> 5.0'
  # to avoid GoogleUtilities version conflict since firebase analytics and firebase Messaging can have different version of GoogleUtilities
  pod 'GoogleUtilities', :modular_headers => true
  # pod 'GoogleUtilities'
  pod 'Firebase/Analytics', :modular_headers => true
  pod 'Firebase', :modular_headers => true
  pod 'FirebaseCoreInternal', :modular_headers => true
  pod 'FirebaseCore', :modular_headers => true
  $RNFirebaseAsStaticFramework = true
  #END to avoid GoogleUtilities version conflict since firebase analytics and firebase Messaging can have different version of GoogleUtilities

  pre_install do |installer|
    Pod::Installer::Xcode::TargetValidator.send(:define_method, :verify_no_static_framework_transitive_dependencies) {}
    installer.pod_targets.each do |pod|
      if pod.name.eql?('RNPermissions') || pod.name.start_with?('Permission-') || pod.name.eql?('RNReanimated') || pod.name.eql?('RNScreens')
        def pod.build_type;
          # Uncomment the line corresponding to your CocoaPods version
          Pod::BuildType.static_library # >= 1.9
          # Pod::Target::BuildType.static_library # < 1.9
        end
      end
    end
  end

  post_install do |installer|
    puts "in post install"

    require 'rexml/document'

    # Helper method to remove application-groups key from an entitlements file
    def remove_app_group_if_needed(entitlements_path)
      return unless File.exist?(entitlements_path)

      is_individual_account = ENV['IS_INDIVIDUAL_ACCOUNT']
      if is_individual_account && !is_individual_account.strip.empty?
        puts "‚ö†Ô∏è Individual account detected. Removing com.apple.security.application-groups from #{entitlements_path}"

        begin
          xml = REXML::Document.new(File.read(entitlements_path))
          root = xml.root
          dict_element = root.elements['dict']
          return unless dict_element

          key_to_remove = nil
          array_to_remove = nil
          
          dict_element.elements.each do |element|
            if element.name == 'key' && element.text == 'com.apple.security.application-groups'
              key_to_remove = element
              array_to_remove = element.next_element
              break
            end
          end

          if key_to_remove && array_to_remove
            dict_element.delete(key_to_remove)
            dict_element.delete(array_to_remove) if array_to_remove.name == 'array'

            File.open(entitlements_path, 'w') do |f|
              formatter = REXML::Formatters::Pretty.new
              formatter.compact = true
              formatter.write(xml, f)
            end

            puts "‚úÖ Removed com.apple.security.application-groups from #{entitlements_path}"
          else
            puts "‚ÑπÔ∏è com.apple.security.application-groups not found in #{entitlements_path}"
          end
        rescue => e
          puts "‚ùå Error processing #{entitlements_path}: #{e.message}"
        end
      else
        puts "‚ÑπÔ∏è IS_INDIVIDUAL_ACCOUNT not set, keeping application group entitlement in #{entitlements_path}"
      end
    end

    entitlements_paths = [
      'apptileSeed/apptileSeed.entitlements',
      'ImageNotification/ImageNotification.entitlements'
    ]

    entitlements_paths.each do |path|
      full_path = File.join(__dir__, path)
      remove_app_group_if_needed(full_path)
    end

    puts "Setting preprocessor definitions from feature flags"
    
    # Set preprocessor definitions directly on target build settings
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        # Get existing preprocessor definitions
        existing_definitions = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] || ['$(inherited)']
        existing_definitions = [existing_definitions] unless existing_definitions.is_a?(Array)
        
        # Add feature flags
        FLAGS.each do |flag|
          flag_enabled = feature_flags[flag]
          flag_definition = "#{flag}=1"
          
          if flag_enabled
            unless existing_definitions.include?(flag_definition)
              existing_definitions << flag_definition
              puts "‚úÖ Added #{flag_definition} to #{target.name} - #{config.name}"
            end
          else
            if existing_definitions.include?(flag_definition)
              existing_definitions.delete(flag_definition)
              puts "üóëÔ∏è  Removed #{flag_definition} from #{target.name} - #{config.name}"
            end
          end
        end
        
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = existing_definitions
      end
    end

    # Also update xcconfig files for reference
    puts "Updating xcconfig files"
    
    app_version = apptile_config.dig('ios', 'version') || '1.0.0'
    build_number = apptile_config.dig('ios', 'build_number') || '1'
    puts "Setting app version to #{app_version} and build number to #{build_number}"
    
    xcconfig_paths=[
      ["./Pods/Target Support Files/Pods-apptileSeed/Pods-apptileSeed.debug.xcconfig", bundle_id],
      ["./Pods/Target Support Files/Pods-apptileSeed/Pods-apptileSeed.release.xcconfig", bundle_id],
      ["./Pods/Target Support Files/Pods-ImageNotification/Pods-ImageNotification.debug.xcconfig", bundle_id + '.ImageNotification'],
      ["./Pods/Target Support Files/Pods-ImageNotification/Pods-ImageNotification.release.xcconfig", bundle_id + '.ImageNotification'],
      ["./Pods/Target Support Files/Pods-NotificationContentExtension/Pods-NotificationContentExtension.debug.xcconfig", bundle_id + '.NotificationContentExtension'],
      ["./Pods/Target Support Files/Pods-NotificationContentExtension/Pods-NotificationContentExtension.release.xcconfig", bundle_id + '.NotificationContentExtension']
    ]
    
    xcconfig_paths.each do |path, productBundleIdentifier|
      if File.exist?(path)
        puts "Modifying #{path}"
        file_contents = File.read(path)
        updated_contents = file_contents

        FLAGS.each do |flag|
          flag_enabled = feature_flags[flag]
          if flag_enabled
            unless updated_contents.include?("#{flag}=1")
              updated_contents = updated_contents.gsub(
                /^GCC_PREPROCESSOR_DEFINITIONS = (.+)$/i,
                'GCC_PREPROCESSOR_DEFINITIONS = \1 ' + flag + '=1'
              )
              unless updated_contents.include?("GCC_PREPROCESSOR_DEFINITIONS")
                updated_contents += "\nGCC_PREPROCESSOR_DEFINITIONS = #{flag}=1\n"
              end
            end
          else
            if updated_contents.include?("#{flag}=1")
              updated_contents = updated_contents.gsub(/\s*#{flag}=1/, '')
            end
          end
        end
        
        updated_contents = updated_contents.gsub(
          /^PRODUCT_BUNDLE_IDENTIFIER = (.+)$/i,
          'PRODUCT_BUNDLE_IDENTIFIER = ' + productBundleIdentifier 
        )

        unless updated_contents.include?("PRODUCT_BUNDLE_IDENTIFIER")
          updated_contents += "\nPRODUCT_BUNDLE_IDENTIFIER = #{productBundleIdentifier}\n"
        end

        File.write(path, updated_contents)
      end
    end
    
    # Swift compilation conditions for NotificationContentExtension
    xcconfig_paths=[
      ["./Pods/Target Support Files/Pods-NotificationContentExtension/Pods-NotificationContentExtension.debug.xcconfig", bundle_id + '.NotificationContentExtension'],
      ["./Pods/Target Support Files/Pods-NotificationContentExtension/Pods-NotificationContentExtension.release.xcconfig", bundle_id + '.NotificationContentExtension'],
    ]
    
    xcconfig_paths.each do |path, productBundleIdentifier|
      if File.exist?(path)
        file_contents = File.read(path)
        updated_contents = file_contents
        
        FLAGS.each do |flag|
          flag_enabled = feature_flags[flag]
          if flag_enabled
            unless updated_contents.include?("#{flag}")
              updated_contents = updated_contents.gsub(
                /^SWIFT_ACTIVE_COMPILATION_CONDITIONS = (.+)$/i,
                'SWIFT_ACTIVE_COMPILATION_CONDITIONS = \1 ' + flag
              )
              unless updated_contents.include?("SWIFT_ACTIVE_COMPILATION_CONDITIONS")
                updated_contents += "\nSWIFT_ACTIVE_COMPILATION_CONDITIONS = #{flag}\n"
              end
            end
          else
            if updated_contents.include?("#{flag}")
              updated_contents = updated_contents.gsub(/\s*#{flag}/, '')
            end
          end
        end

        updated_contents = updated_contents.gsub(
          /^PRODUCT_BUNDLE_IDENTIFIER = (.+)$/i,
          'PRODUCT_BUNDLE_IDENTIFIER = ' + productBundleIdentifier 
        )

        unless updated_contents.include?("PRODUCT_BUNDLE_IDENTIFIER")
          updated_contents += "\nPRODUCT_BUNDLE_IDENTIFIER = #{productBundleIdentifier}\n"
        end

        File.write(path, updated_contents)
      end
    end
    
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false
    )

    installer.pods_project.targets.each do |target|
      if target.name == 'RNReactNativeHapticFeedback'
        target.build_configurations.each do |config|
          config.build_settings['OTHER_LDFLAGS'] ||= ['$(inherited)']
          config.build_settings['OTHER_LDFLAGS'] << '-framework AudioToolbox'
        end
      end
    end

    script_path = "./update_versions.rb"
    if File.exist?(script_path)
      File.chmod(0755, script_path) unless File.executable?(script_path)
      system(script_path)
    else
      puts "Warning: update_versions.rb script not found at #{script_path}"
    end

    # NEW SECTION: Set preprocessor definitions in main app target
    puts "\n" + "=" * 80
    puts "Setting preprocessor definitions in main app target"
    puts "=" * 80
    
    main_project_path = File.join(__dir__, 'apptileSeed.xcodeproj')
    if File.exist?(main_project_path)
      begin
        main_project = Xcodeproj::Project.open(main_project_path)
        
        main_project.targets.each do |target|
          # Update all your targets (main app and extensions)
          if ['apptileSeed', 'ImageNotification', 'NotificationContentExtension'].include?(target.name)
            puts "Processing target: #{target.name}"
            
            target.build_configurations.each do |config|
              puts "  Configuration: #{config.name}"
              
              # Get existing definitions
              definitions = config.build_settings['GCC_PREPROCESSOR_DEFINITIONS']
              
              if definitions.nil?
                definitions = ['$(inherited)']
              elsif definitions.is_a?(String)
                definitions = [definitions]
              else
                definitions = definitions.dup
              end
              
              # Ensure $(inherited) is first
              definitions.delete('$(inherited)')
              definitions.unshift('$(inherited)')
              
              # Remove old flags first
              FLAGS.each do |flag|
                flag_def = "#{flag}=1"
                definitions.delete(flag_def)
              end
              
              # Add enabled feature flags
              FLAGS.each do |flag|
                if feature_flags[flag]
                  flag_def = "#{flag}=1"
                  definitions << flag_def
                  puts "    ‚úÖ Added #{flag_def}"
                end
              end
              
              config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] = definitions
            end
          end
        end
        
        main_project.save
        puts "‚úÖ Main project preprocessor definitions updated successfully"
      rescue => e
        puts "‚ùå Error updating main project: #{e.message}"
        puts e.backtrace.join("\n")
      end
    else
      puts "‚ö†Ô∏è  Could not find main project at #{main_project_path}"
    end
    
    puts "=" * 80
  end
end

# target 'apptileSeedClip' do
#   swap_package_json_for_appclip do
#     config = use_native_modules!
#
#     use_react_native!(
#       :path => config[:reactNativePath],
#       # Enables Flipper.
#       #
#       # Note that if you have use_frameworks! enabled, Flipper will not work and
#       # you should disable the next line.
#       :flipper_configuration => flipper_config,
#       # An absolute path to your application root.
#       :app_path => "#{Pod::Config.instance.installation_root}/..",
#       :hermes_enabled => false
#     )
#   end
# end